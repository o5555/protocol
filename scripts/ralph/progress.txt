# Ralph Progress Log
Started: Thu Jan 29 14:56:52 CST 2026
---

## Codebase Patterns
- Use CommonJS `require()` for Playwright test imports (not ES modules)
- Supabase stores auth session in localStorage with key pattern `sb-<project>-auth-token`
- Test fixtures should be in `tests/e2e/helpers/fixtures.js` for reuse
- Auth helpers should use `page.addInitScript()` to inject state before page loads
- Global modules (Auth, SupabaseClient, Dashboard, Comparison, SleepSync, Challenges, Friends) are exposed on `window` object
- App module is inline in index.html as `const App` - use `App.navigateTo()` directly, NOT `window.App.navigateTo()`
- For tests that don't need network, use `waitForLoadState('domcontentloaded')` instead of `networkidle`
- For tests that need App object, use `waitForLoadState('networkidle')` to ensure inline scripts have run
- When testing rendered content in hidden containers (e.g., #challenges-container in hidden #page-challenges), use `toBeAttached()` not `toBeVisible()`
- For form inputs in hidden containers, use `page.evaluate()` to set values instead of Playwright's `fill()` method
- When mocking async module methods, mock all dependent methods to prevent network calls (e.g., both Friends.getPendingRequests AND Challenges.getInvitations)

---

## 2026-01-29 - US-001
- What was implemented:
  - Created `tests/e2e/helpers/auth.js` with auth helper functions:
    - `mockAuthenticatedState()` - Injects mock session into localStorage
    - `clearAuthState()` - Removes auth tokens from localStorage
    - `setupAuthenticatedPage()` - Sets up page with mocked auth before test
    - `setupUnauthenticatedPage()` - Sets up page in logged-out state
    - `injectMockModules()` - Injects test mode flags and mock data
  - Created `tests/e2e/helpers/fixtures.js` with test data:
    - MOCK_USER, MOCK_USER_2 - Mock user objects
    - MOCK_SESSION - Mock Supabase session with tokens
    - MOCK_PROFILE - Mock user profile with onboarding completed
    - MOCK_SLEEP_DATA - Mock sleep records for dashboard tests
    - generateBaselineSleepData() - Helper to generate 30-day baseline
    - MOCK_FRIENDS, MOCK_FRIEND_REQUESTS - Mock friend data
    - MOCK_CHALLENGE, MOCK_CHALLENGE_PARTICIPANTS, MOCK_CHALLENGE_INVITATIONS
  - Created `tests/e2e/helpers/helpers.spec.js` with 17 passing tests
- Files changed:
  - tests/e2e/helpers/auth.js (new)
  - tests/e2e/helpers/fixtures.js (new)
  - tests/e2e/helpers/helpers.spec.js (new)
- **Learnings for future iterations:**
  - The actual email input ID is `auth-email` not `magic-link-email` (existing test in auth.spec.js has wrong ID)
  - App module is defined inline in index.html inside a script tag, not exported to window.App consistently
  - Some existing E2E tests (auth.spec.js, friends.spec.js) have failures unrelated to this story
  - Use `page.addInitScript()` to inject data BEFORE page navigation for auth mocking
---

## 2026-01-29 - US-002
- What was implemented:
  - Created `tests/e2e/auth-flow.spec.js` with 21 comprehensive auth UI tests:
    - Auth section visibility tests (unauthenticated state)
    - Tab switching tests (Magic Link ↔ Password)
    - Magic link form validation tests (email required, email format)
    - Password form tests (both email and password fields visible and validated)
    - Error message element and styling tests
    - Authenticated user state tests (session data verification)
- Files changed:
  - tests/e2e/auth-flow.spec.js (new)
- **Learnings for future iterations:**
  - Tab buttons use `Auth.switchAuthTab()` to toggle visibility between forms
  - Magic link form uses `#auth-email` and password form uses `#auth-email-pw` and `#auth-password`
  - Error messages use `#auth-message` (magic link) and `#auth-message-pw` (password)
  - HTML5 validation can be tested via `element.checkValidity()` method
  - Tab active state is indicated by `bg-oura-border` CSS class
---

## 2026-01-29 - US-003
- What was implemented:
  - Created `tests/e2e/dashboard-flow.spec.js` with 67 comprehensive dashboard tests:
    - Module loading verification (Dashboard, Comparison, SleepSync modules)
    - Sleep metric calculations (calcAvgHR, calcAvgPreSleepHR, calcAvgDeepSleep, calcAvgSleepScore)
    - Min/max HR functions with empty data handling (getMinHR, getMaxHR)
    - Motivational message generation based on HR levels and challenge state
    - Comparison module tests (calcMedian for odd/even arrays, calcAverages with baseline logic)
    - Change indicators (formatChange with correct arrows and colors)
    - UI elements verification in unauthenticated state
    - Navigation structure tests (buttons, data-page attributes, onclick handlers)
    - Chart module tests (Chart.js, renderSparkline, Comparison colors)
    - Baseline vs current period logic with median fill for missing days
- Files changed:
  - tests/e2e/dashboard-flow.spec.js (new - 585 lines, 67 tests)
- **Learnings for future iterations:**
  - App module is defined inline in index.html and not consistently exposed as `window.App` - avoid tests that depend on this
  - Dashboard, Comparison, SleepSync modules are properly exported to window object and can be tested
  - Authenticated state requires real Supabase auth - mock auth helpers only inject localStorage but Supabase validates server-side
  - Use `page.waitForLoadState('domcontentloaded')` for faster tests that don't need full network idle
  - formatChange returns HTML with `text-green-400` or `text-red-400` classes and `↑`/`↓` arrows
  - Empty data states return `null` from calc functions and `'--'` placeholders from display functions
---

## 2026-01-29 - US-004
- What was implemented:
  - Created `tests/e2e/challenges-flow.spec.js` with 87 comprehensive challenge tests:
    - Module loading verification (Challenges module and all 16 key methods)
    - Date helper functions (toLocalDateStr, parseLocalDate, getDayNumber, getDaysRemaining, isActive)
    - UI structure verification in unauthenticated state (containers, badges, nav buttons)
    - Create challenge modal tests (protocol select, mode selector, friends list, form, buttons)
    - Invite friends modal tests (email input, status feedback, friend filtering, close behavior)
    - Challenges list rendering tests (Create button, empty state, invitations section, Join/Decline buttons, active challenges)
    - Challenge detail rendering tests (name, day number, Back button, habits section, checkboxes, participant progress, Invite Friends button, Sleep Performance)
    - Navigation integration tests (App.navigateTo for challenges and challenge-detail pages)
    - Badge notification tests (hidden initially, shows/hides based on invitations)
- Files changed:
  - tests/e2e/challenges-flow.spec.js (new - 1350+ lines, 87 tests)
- **Learnings for future iterations:**
  - `const App` in inline script is accessible as global `App`, NOT `window.App` - use direct access
  - Challenges.renderList renders into hidden #challenges-container - use `toBeAttached()` for DOM structure verification
  - Date helpers: toLocalDateStr pads month/day, parseLocalDate creates local midnight dates, getDayNumber minimum is 1, getDaysRemaining minimum is 0
  - Challenge invitations section uses yellow styling (yellow-900/20, yellow-600, yellow-400)
  - Mode selector uses Protocols.renderModeSelector() and Protocols._selectedMode for state
  - Invite friends modal filters out friends already in challenge via participant user IDs
---

## 2026-01-29 - US-005
- What was implemented:
  - Created `tests/e2e/friends-flow.spec.js` with 91 comprehensive friends tests:
    - Module loading verification (Friends module and all 19 key methods)
    - UI structure verification in unauthenticated state (containers, badges, page structure)
    - Navigation tests (nav button existence, data-page attributes, App.navigateTo integration)
    - Friends list rendering tests (Add Friend section, invite form, email input, Send Invite button)
    - Empty state tests (no friends message, invitation call to action, count display)
    - Friends data tests (friend count, display names, email rendering, Remove buttons)
    - Pending requests tests (Friend Requests section, count, Accept/Decline buttons with handlers)
    - Sent requests tests (Sent Requests section with count and Pending status)
    - Pending invite links tests (Invite Links Sent section, Cancel button, auto-connect message)
    - Badge notification tests (badge existence, hidden state, checkNotifications integration)
    - Search/invite form tests (email input typing, HTML5 validation, form submission)
    - Error state tests (error messages, red styling, border)
    - App notifications integration tests (App.checkNotifications, App.init, navigation triggers)
- Files changed:
  - tests/e2e/friends-flow.spec.js (new - 1250+ lines, 91 tests)
- **Learnings for future iterations:**
  - Nav buttons inside #app-content are hidden when unauthenticated - use `toBeAttached()` not `toBeVisible()`
  - For form inputs in hidden containers, use `page.evaluate()` to set values via JavaScript instead of Playwright `fill()`
  - When mocking Friends.getPendingRequests for checkNotifications, also mock Challenges.getInvitations to prevent network calls
  - Friends.render() is async and needs sufficient wait time (300ms+) before accessing rendered elements
  - Remove buttons use `onclick="Friends.handleRemove('friendshipId')"` pattern - query with `[onclick*="handleRemove"]`
  - HTML5 form validation can be tested via `input.checkValidity()` in page.evaluate()
---
